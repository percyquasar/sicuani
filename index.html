<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>
	<link rel="stylesheet" type="text/css" href="https://archive.org/download/modulos_202601/libs/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="https://archive.org/download/modulos_202601/libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="https://archive.org/download/modulos_202601/libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="https://archive.org/download/modulos_202601/libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="https://archive.org/download/modulos_202601/libs/jstree/themes/mixed/style.css">
</head>
<body>
	
	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area" style="background-image: url('https://archive.org/download/modulos_202601/build/potree/resources/images/background.jpg');"></div>
		<div id="potree_sidebar_container"> </div>
	</div>
	
	<script>
		// Función para cargar scripts usando fetch y eval
		async function loadScript(url) {
			try {
				const response = await fetch(url, {
					mode: 'cors',
					credentials: 'omit'
				});
				
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				
				const scriptContent = await response.text();
				
				// Ejecutar el script
				const script = document.createElement('script');
				script.textContent = scriptContent;
				document.head.appendChild(script);
				
				console.log('Loaded:', url);
				return true;
			} catch (error) {
				console.error('Failed to load:', url, error);
				
				// Intento alternativo: usar eval
				try {
					const response = await fetch(url);
					const scriptContent = await response.text();
					eval(scriptContent);
					console.log('Loaded with eval:', url);
					return true;
				} catch (evalError) {
					console.error('Eval also failed:', evalError);
					return false;
				}
			}
		}

		// Lista de scripts en orden de dependencia
		const scripts = [
			'https://archive.org/download/modulos_202601/libs/jquery/jquery-3.1.1.min.js',
			'https://archive.org/download/modulos_202601/libs/spectrum/spectrum.js',
			'https://archive.org/download/modulos_202601/libs/jquery-ui/jquery-ui.min.js',
			'https://archive.org/download/modulos_202601/libs/other/BinaryHeap.js',
			'https://archive.org/download/modulos_202601/libs/tween/tween.min.js',
			'https://archive.org/download/modulos_202601/libs/d3/d3.js',
			'https://archive.org/download/modulos_202601/libs/proj4/proj4.js',
			'https://archive.org/download/modulos_202601/libs/openlayers3/ol.js',
			'https://archive.org/download/modulos_202601/libs/i18next/i18next.js',
			'https://archive.org/download/modulos_202601/libs/jstree/jstree.js',
			'https://archive.org/download/modulos_202601/libs/potree/potree.js',
			'https://archive.org/download/modulos_202601/libs/plasio/js/laslaz.js'
		];

		// Cargar todos los scripts secuencialmente
		async function loadAllScripts() {
			try {
				for (const src of scripts) {
					const success = await loadScript(src);
					if (!success) {
						throw new Error(`Failed to load: ${src}`);
					}
					// Pequeña pausa entre cargas para asegurar que se ejecuten en orden
					await new Promise(resolve => setTimeout(resolve, 100));
				}
				console.log('All scripts loaded successfully');
				initPotree();
			} catch (error) {
				console.error('Error loading scripts:', error);
			}
		}

		// Inicializar Potree después de cargar todos los scripts
		function initPotree() {
			if (typeof Potree === 'undefined') {
				console.error('Potree is not defined. Scripts may not have loaded correctly.');
				return;
			}

			window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
			
			viewer.setEDLEnabled(true);
			viewer.setFOV(60);
			viewer.setPointBudget(2_000_000);
			viewer.loadSettingsFromURL();
			
			viewer.setDescription("");
			
			viewer.loadGUI(() => {
				viewer.setLanguage('en');
				$("#menu_appearance").next().show();
				$("#menu_tools").next().show();
				$("#menu_clipping").next().show();
				viewer.toggleSidebar();
			});
			
			Potree.loadPointCloud("https://archive.org/download/chumo/pointclouds/PERCY/metadata.json", "PERCY", e => {
				let scene = viewer.scene;
				let pointcloud = e.pointcloud;
				
				let material = pointcloud.material;
				material.size = 1;
				material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
				material.shape = Potree.PointShape.SQUARE;
				material.activeAttributeName = "rgba";
				
				scene.addPointCloud(pointcloud);
				
				viewer.fitToScreen();
			});
		}

		// Iniciar la carga de scripts
		loadAllScripts();
	</script>
	
</body>
</html>
